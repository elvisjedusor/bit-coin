name: Linux Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Linux Build (Ubuntu)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libdb-dev libdb5.3-dev \
          libboost-all-dev \
          libwxgtk3.0-gtk3-dev \
          libgtk-3-dev \
          file \
          fuse libfuse2

    - name: Download linuxdeploy
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage

    - name: Build release daemon (static)
      run: |
        make -f makefile.unix clean
        make -f makefile.unix release-daemon RELEASE_ARCH=x86-64-v2

    - name: Build release GUI
      run: |
        make -f makefile.unix release-gui RELEASE_ARCH=x86-64-v2

    - name: Verify binaries
      run: |
        echo "=== bitokd info ==="
        file release/bitokd
        ldd release/bitokd || echo "Static binary (minimal deps)"
        ./release/bitokd -? || echo "Daemon test OK"
        echo ""
        echo "=== bitok info ==="
        file release/bitok
        ldd release/bitok

    - name: Create AppImage
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

        cp release/bitok AppDir/usr/bin/

        cat > AppDir/usr/share/applications/bitok.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=Bitok
        Exec=bitok
        Icon=bitok
        Categories=Finance;Network;
        Comment=Bitok Cryptocurrency Wallet
        EOF

        cp AppDir/usr/share/applications/bitok.desktop AppDir/

        # Create placeholder icon if none exists
        if [ ! -f bitok.png ]; then
          convert -size 256x256 xc:'#2563eb' \
            -fill white -gravity center \
            -pointsize 72 -annotate 0 'B' \
            bitok.png 2>/dev/null || \
          echo "No icon available, continuing without"
        fi

        if [ -f bitok.png ]; then
          cp bitok.png AppDir/usr/share/icons/hicolor/256x256/apps/
          cp bitok.png AppDir/
        fi

        ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage || true

        # Rename AppImage
        for f in Bitok*.AppImage; do
          if [ -f "$f" ]; then
            mv "$f" "release/Bitok-0.3.19-x86_64.AppImage"
          fi
        done

    - name: Create release packages
      run: |
        VERSION="0.3.19"
        ARCH="x86_64"

        cd release

        cat > README-DAEMON.txt << 'EOF'
        Bitok v0.3.19 - Linux Daemon
        ============================

        QUICK START
        -----------
        1. Run daemon:
           ./bitokd -daemon

        2. Check status:
           ./bitokd getinfo

        3. Stop daemon:
           ./bitokd stop

        DATA LOCATION
        -------------
        Data directory: ~/.bitokd/
        Config: ~/.bitokd/bitokd.conf

        SYSTEM REQUIREMENTS
        -------------------
        - x86_64 CPU (2009 or newer with SSE4.2)
        - glibc 2.17+ (any modern Linux)
        - OpenSSL 1.1+ or 3.x

        License: MIT
        EOF

        cat > README-APPIMAGE.txt << 'EOF'
        Bitok v0.3.19 - Linux GUI Wallet (AppImage)
        ============================================

        QUICK START
        -----------
        1. Make executable:
           chmod +x Bitok-0.3.19-x86_64.AppImage

        2. Run:
           ./Bitok-0.3.19-x86_64.AppImage

        No installation required - runs on any modern Linux!

        DATA LOCATION
        -------------
        Wallet: ~/.bitokd/wallet.dat

        IMPORTANT: Backup wallet.dat regularly!

        SYSTEM REQUIREMENTS
        -------------------
        - x86_64 CPU (2009 or newer with SSE4.2)
        - glibc 2.17+ (Ubuntu 18.04+, Debian 10+, Fedora 30+)
        - FUSE for AppImage support

        If FUSE is missing:
          sudo apt install fuse libfuse2

        License: MIT
        EOF

        tar -czf "bitokd-${VERSION}-linux-${ARCH}.tar.gz" bitokd README-DAEMON.txt ../license.txt

        if [ -f "Bitok-${VERSION}-${ARCH}.AppImage" ]; then
          cp README-APPIMAGE.txt README.txt
          zip "Bitok-${VERSION}-linux-${ARCH}.zip" "Bitok-${VERSION}-${ARCH}.AppImage" README.txt ../license.txt
        fi

        sha256sum "bitokd-${VERSION}-linux-${ARCH}.tar.gz" > "bitokd-${VERSION}-linux-${ARCH}.tar.gz.sha256"

        if [ -f "Bitok-${VERSION}-linux-${ARCH}.zip" ]; then
          sha256sum "Bitok-${VERSION}-linux-${ARCH}.zip" > "Bitok-${VERSION}-linux-${ARCH}.zip.sha256"
        fi

        cat > CHECKSUMS-LINUX.txt << EOF
        Bitok v${VERSION} - Linux Release Checksums
        ============================================

        Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Platform: Linux x86_64 (glibc 2.17+)

        Verify with:
          sha256sum -c CHECKSUMS-LINUX.txt

        SHA-256 Checksums:
        ==================

        EOF

        sha256sum *.tar.gz >> CHECKSUMS-LINUX.txt 2>/dev/null || true
        sha256sum *.zip >> CHECKSUMS-LINUX.txt 2>/dev/null || true
        sha256sum *.AppImage >> CHECKSUMS-LINUX.txt 2>/dev/null || true

        echo ""
        echo "========================================="
        echo "Linux Release Packages Created"
        echo "========================================="
        ls -lh
        echo ""
        cat CHECKSUMS-LINUX.txt

    - name: Upload daemon package
      uses: actions/upload-artifact@v4
      with:
        name: bitokd-linux-x86_64
        path: |
          release/bitokd-0.3.19-linux-*.tar.gz
          release/bitokd-0.3.19-linux-*.tar.gz.sha256

    - name: Upload AppImage package
      uses: actions/upload-artifact@v4
      with:
        name: bitok-linux-x86_64
        path: |
          release/Bitok-0.3.19-*.AppImage
          release/Bitok-0.3.19-linux-*.zip
          release/Bitok-0.3.19-linux-*.zip.sha256
        if-no-files-found: warn

    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: checksums-linux
        path: release/CHECKSUMS-LINUX.txt
