name: Windows Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build (MinGW Cross-Compile)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install MXE dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf automake autopoint bash bison bzip2 flex g++ g++-multilib \
          gettext git gperf intltool libc6-dev-i386 libgdk-pixbuf2.0-dev \
          libltdl-dev libgl-dev libpcre3-dev libssl-dev libtool-bin libxml-parser-perl \
          lzip make openssl p7zip-full patch perl python3 python3-mako python3-packaging \
          ruby sed unzip wget xz-utils

    - name: Cache MXE
      id: cache-mxe
      uses: actions/cache@v4
      with:
        path: ~/mxe
        key: mxe-win64-static-v3-${{ hashFiles('.github/workflows/windows-build.yml') }}
        restore-keys: |
          mxe-win64-static-v3-

    - name: Build MXE toolchain
      if: steps.cache-mxe.outputs.cache-hit != 'true'
      run: |
        cd ~
        git clone https://github.com/mxe/mxe.git
        cd mxe

        cat > settings.mk << 'EOF'
        MXE_TARGETS := x86_64-w64-mingw32.static
        MXE_PLUGIN_DIRS := plugins/gcc14
        EOF

        make -j$(nproc) cc openssl boost db wxwidgets zlib

    - name: Verify MXE installation
      run: |
        export PATH=~/mxe/usr/bin:$PATH
        echo "=== MXE Toolchain ==="
        x86_64-w64-mingw32.static-g++ --version
        echo ""
        echo "=== wx-config ==="
        x86_64-w64-mingw32.static-wx-config --version
        x86_64-w64-mingw32.static-wx-config --cxxflags | head -c 200
        echo "..."

    - name: Build Windows daemon
      run: |
        export PATH=~/mxe/usr/bin:$PATH
        make -f makefile.mingw clean
        make -f makefile.mingw daemon MARCH=x86-64-v2

    - name: Build Windows GUI
      run: |
        export PATH=~/mxe/usr/bin:$PATH
        make -f makefile.mingw gui MARCH=x86-64-v2

    - name: Verify binaries
      run: |
        echo "=== bitokd.exe info ==="
        file bitokd.exe
        x86_64-w64-mingw32.static-objdump -p bitokd.exe | grep "DLL Name" || echo "No DLL dependencies (static)"
        ls -lh bitokd.exe
        echo ""
        echo "=== bitok.exe info ==="
        file bitok.exe
        x86_64-w64-mingw32.static-objdump -p bitok.exe | grep "DLL Name" || echo "No DLL dependencies (static)"
        ls -lh bitok.exe

    - name: Create release packages
      run: |
        VERSION="0.3.19"

        mkdir -p release
        cp bitokd.exe release/
        cp bitok.exe release/

        cd release

        cat > README.txt << 'ENDREADME'
        Bitok v0.3.19 - Windows Release
        ================================

        CONTENTS
        --------
        - bitok.exe    : GUI wallet application
        - bitokd.exe   : Command-line daemon (for servers/advanced users)

        QUICK START (GUI)
        -----------------
        1. Double-click bitok.exe
        2. Wait for blockchain sync
        3. Use File > New Address to create receiving address

        QUICK START (Daemon)
        --------------------
        1. Open Command Prompt
        2. Run: bitokd.exe -daemon
        3. Check status: bitokd.exe getinfo
        4. Stop: bitokd.exe stop

        DATA LOCATION
        -------------
        Windows: %APPDATA%\Bitok\
        - wallet.dat  : Your wallet (BACKUP THIS FILE!)
        - bitok.conf  : Configuration file

        SYSTEM REQUIREMENTS
        -------------------
        - Windows 10 or later (64-bit)
        - x86-64 CPU with SSE4.2 (Intel 2008+, AMD 2011+)
        - No additional software required (fully static build)

        CONFIGURATION
        -------------
        Create %APPDATA%\Bitok\bitok.conf with:

          rpcuser=yourusername
          rpcpassword=yourpassword
          server=1

        FIREWALL
        --------
        Allow TCP port 8639 for incoming connections (optional)

        LICENSE
        -------
        MIT License - See license.txt

        SUPPORT
        -------
        https://github.com/elvisjedusor/bitok
        ENDREADME

        cp ../license.txt .

        cd ..

        7z a -tzip "release/Bitok-${VERSION}-win64.zip" \
          release/bitok.exe \
          release/bitokd.exe \
          release/README.txt \
          release/license.txt

        cd release
        sha256sum "Bitok-${VERSION}-win64.zip" > "Bitok-${VERSION}-win64.zip.sha256"
        sha256sum bitok.exe > bitok.exe.sha256
        sha256sum bitokd.exe > bitokd.exe.sha256

        cat > CHECKSUMS-WINDOWS.txt << EOF
        Bitok v${VERSION} - Windows Release Checksums
        ==============================================

        Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        Platform: Windows 10+ x64 (static build)
        Compiler: MinGW-w64 (MXE cross-compile)

        Verify with PowerShell:
          Get-FileHash -Algorithm SHA256 Bitok-${VERSION}-win64.zip

        Or with certutil:
          certutil -hashfile Bitok-${VERSION}-win64.zip SHA256

        SHA-256 Checksums:
        ==================
        EOF

        sha256sum *.zip >> CHECKSUMS-WINDOWS.txt
        echo "" >> CHECKSUMS-WINDOWS.txt
        echo "Individual binaries:" >> CHECKSUMS-WINDOWS.txt
        sha256sum bitok.exe bitokd.exe >> CHECKSUMS-WINDOWS.txt

        echo ""
        echo "========================================="
        echo "Windows Release Packages Created"
        echo "========================================="
        ls -lh
        echo ""
        cat CHECKSUMS-WINDOWS.txt

    - name: Upload Windows release
      uses: actions/upload-artifact@v4
      with:
        name: bitok-windows-x64
        path: |
          release/Bitok-0.3.19-win64.zip
          release/Bitok-0.3.19-win64.zip.sha256

    - name: Upload individual binaries
      uses: actions/upload-artifact@v4
      with:
        name: bitok-windows-binaries
        path: |
          release/bitok.exe
          release/bitokd.exe
          release/*.sha256

    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: checksums-windows
        path: release/CHECKSUMS-WINDOWS.txt
